import{a as z,a2 as D,j as o,o as V,a3 as Y,m as F,s as L,a4 as X,n as T}from"./index-BBkS68sv.js";import{P as $,b as Z,c as ee,C as B}from"./index-BZrXSPkn.js";import{k as te,l as ne}from"./index-D9JUB6hU.js";import{C as oe}from"./SendOutlined-B7Eu_wmm.js";import{D as se}from"./DeleteOutlined-B6bglta-.js";import"./VariableBind-O5QUcdA4.js";import"./index-DsdcxFhl.js";import"./SaveOutlined-BQ_jcTgK.js";import"./ColorPicker-Dw8Os0Zn.js";import"./CodeOutlined-EqGcmDkC.js";import"./LockOutlined-Ds8QM0LA.js";import"./TeamOutlined-D9jTqjd3.js";import"./UserOutlined-BbJ58T22.js";const ae=window.antd.Space,R=window.antd.Tooltip,ie=window.React.memo,H=window.React.useEffect,K=window.React.useState,de=ie(({hoverTarget:m,copyElement:b,pastElement:E,delElement:a})=>{var h,N,I,P,S,x;const{selectedElement:l,elements:j,isFirstNode:g,nodeNav:c,isUpdateToolbar:_,setSelectedElement:C,moveElements:v}=z(t=>{var i,s;const d=(i=t.selectedElement)==null?void 0:i.id,p=d?t.page.elementsMap[d]:null,e={};if(p){if(p.parentId){const{id:r,type:O,name:A}=t.page.elementsMap[p.parentId];e.parent={id:r,type:O,name:A}}e.current={id:p.id,type:p.type,name:p.name};const n=Object.values(t.page.elementsMap).find(r=>r.parentId===p.id);n&&(e.child={id:n.id,type:n.type,name:n.name})}return{selectedElement:t.selectedElement,elements:t.page.elements,isFirstNode:((s=t.page.elements[0])==null?void 0:s.id)===d,nodeNav:e,isUpdateToolbar:t.isUpdateToolbar,setSelectedElement:t.setSelectedElement,moveElements:t.moveElements}}),[W,M]=K({}),[u,f]=K({});H(()=>{l&&setTimeout(()=>{const t=document.querySelector(`[data-id=${l==null?void 0:l.id}]`),d=D(t);M(d)})},[l,j,_]),H(()=>{if(m){const t=D(m);f({...t})}else f({...u,visibility:"hidden"})},[m]);const w=(t,{id:d,type:p})=>{!d||!p||(C({id:d,type:p}),t.stopPropagation())},y=(t,d)=>{v({componentId:l==null?void 0:l.id,direction:d}),t.stopPropagation()};return o.jsxs(o.Fragment,{children:[o.jsx("div",{className:l?"toolbar-box selected":"toolbar-box",style:W,id:"editorToolbar",children:o.jsxs("div",{className:g?"tool-bar first":"tool-bar",children:[o.jsxs("div",{className:"node-nav",children:[c.parent&&o.jsx("span",{className:"node-tip parent",onClick:t=>w(t,c.parent),children:((h=c.parent)==null?void 0:h.name)||((N=c.parent)==null?void 0:N.type)}),o.jsx("span",{className:"node-tip current",onClick:t=>w(t,c.current),children:((I=c.current)==null?void 0:I.name)||((P=c.current)==null?void 0:P.type)}),c.child&&o.jsx("span",{className:"node-tip child",onClick:t=>w(t,c.child),children:((S=c.child)==null?void 0:S.name)||((x=c.child)==null?void 0:x.type)})]}),o.jsxs(ae,{className:"actions",children:[o.jsx(R,{title:"上移动",children:o.jsx(te,{onClick:t=>y(t,"up")})}),o.jsx(R,{title:"下移动",children:o.jsx(ne,{onClick:t=>y(t,"down")})}),o.jsx(R,{title:"复制",children:o.jsx(oe,{onClick:t=>{b(),E(),t.stopPropagation()}})}),o.jsx(R,{title:"删除",children:o.jsx(se,{onClick:t=>{a(),t.stopPropagation()}})})]})]})}),o.jsx("div",{className:m?"toolbar-box hover":"toolbar-box",style:u})]})}),re=window.React,q=window.React.useState,le=window.React.useEffect,ce=window.antd.ConfigProvider,pe=window.antd.InputNumber,me=window.ahooks.useDebounceFn,U=window.ahooks.useKeyPress,Ne=()=>{const{mode:m,canvasWidth:b,setCanvasWidth:E,selectedElement:a,theme:l,elements:j,elementsMap:g,savePageInfo:c,addElement:_,addChildElements:C,setSelectedElement:v,removeElements:W,clearPageInfo:M}=z(e=>({mode:e.mode,canvasWidth:e.page.canvasWidth,setCanvasWidth:e.setCanvasWidth,selectedElement:e.selectedElement,theme:e.page.config.props.theme,pageStyle:e.page.config.style,elements:e.page.elements,elementsMap:e.page.elementsMap,savePageInfo:e.savePageInfo,addElement:e.addElement,addChildElements:e.addChildElements,setSelectedElement:e.setSelectedElement,removeElements:e.removeElements,clearPageInfo:e.clearPageInfo})),[u,f]=q(null),[w,y]=q(!1),{id:h}=V();le(()=>{if(h)return y(!1),Y(parseInt(h)).then(e=>{let i={};try{i=JSON.parse(e.page_data||"{}")}catch(s){console.error(s),console.info("【json数据】",e.page_data),F.error("页面数据格式错误，请检查")}c({config:$.config,events:$.events,...i,pageId:e.id,pageName:e.name,remark:e.remark,is_public:e.is_public,preview_img:e.preview_img,state:void 0,stg_publish_id:e.stg_publish_id,pre_publish_id:e.pre_publish_id,prd_publish_id:e.prd_publish_id,stg_state:e.stg_state,pre_state:e.pre_state,prd_state:e.prd_state,user_id:e.user_id}),y(!0),E(Math.max(window.innerWidth-660,i.canvasWidth||0))}),()=>{M(),f(null),v(void 0)}},[h]);const[,N]=Z({accept:"MENU_ITEM",drop(e,i){if(i.didDrop())return;const{config:s,events:n,methods:r=[],elements:O=[]}=B[e.type+"Config"]||{},A=O.map(k=>{const{config:J,events:G,methods:Q=[]}=B[k.type+"Config"]||{};return{id:T(k.type),name:k.name,type:k.type,parentId:e.id,config:J,events:G,methods:Q}})||[];_({type:e.type,name:e.name,id:e.id,config:s,events:n,methods:r,elements:A})},collect:e=>({isOver:e.isOver(),canDrop:e.canDrop()})}),I=e=>{if(e.stopPropagation(),m==="preview")return;const s=e.target.closest("[data-id]");if(s){const n=s==null?void 0:s.dataset.id;if(n===(a==null?void 0:a.id))return;v({id:n,type:s==null?void 0:s.dataset.type}),f(null)}else a!=null&&a.id&&v(void 0)},P=e=>{const i=e.target;if(m==="preview")return;const s=i.closest("[data-id]");if(s){const n=s==null?void 0:s.dataset.id;if(n===(a==null?void 0:a.id)||n===(u==null?void 0:u.dataset.id))return;f(s)}else u&&f(null);e.stopPropagation()},{run:S}=me(P,{wait:150});U(["ctrl.c","meta.c"],e=>{["INPUT","TEXTAREA"].includes(e.target.tagName)||x()}),U(["ctrl.v","meta.v"],e=>{["INPUT","TEXTAREA"].includes(e.target.tagName)||t()}),U(["delete","backspace"],e=>{["INPUT","TEXTAREA"].includes(e.target.tagName)||e.target.contentEditable==="true"||p()});const x=()=>{L.set("copy_component",a==null?void 0:a.id)},t=()=>{var s;const e=L.get("copy_component");if(!e)return F.info("暂无复制内容");const i=(s=g[e])==null?void 0:s.parentId;if(i){const n=X(j,e),r=T(e.split("-")[0]);C({...g[e],elements:[],parentId:i,id:r}),d((n==null?void 0:n.elements)||[],r)}else{const n=X(j,e),r=T(e.split("-")[0]);_({...g[e],elements:[],id:r}),d((n==null?void 0:n.elements)||[],r)}};function d(e,i){var s;for(let n=0;n<e.length;n++){const r=T(e[n].id.split("-")[0]);C({...g[e[n].id],parentId:i,elements:[],id:r}),((s=e[n].elements)==null?void 0:s.length)>0&&d(e[n].elements,r)}}const p=()=>{a&&W(a.id)};return o.jsxs(ce,{theme:{token:{colorPrimary:l||"#1677ff",colorLink:l||"#1677ff",colorInfo:l||"#1677ff"}},children:[m==="edit"&&o.jsx("div",{className:"canvas-size",children:o.jsx(pe,{addonBefore:"画布宽度:",variant:"borderless",value:b,onChange:e=>e&&E(e),style:{width:150}})}),o.jsx("div",{ref:N,className:m==="edit"?"mars-editor":"mars-preview",onClick:I,onMouseOver:S,children:o.jsxs("div",{id:"editor",className:"pageWrapper",style:m==="preview"?{height:"calc(100vh - 64px)",overflow:"auto"}:{minWidth:window.innerWidth-660,width:b||"auto",height:"100%"},children:[m==="edit"&&o.jsx(de,{copyElement:x,pastElement:t,delElement:p,hoverTarget:u}),o.jsx(re.Suspense,{fallback:o.jsx("div",{children:"Loading..."}),children:w&&o.jsx(ee,{})})]})})]})};export{Ne as default};
